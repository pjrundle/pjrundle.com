#!/usr/bin/env node
/**
 * Generate image dimensions manifest for all images in public/.
 * Outputs to src/generated/image-dimensions.ts
 *
 * Usage:
 *   node scripts/generate-image-manifest.mjs
 */

import fs from "node:fs/promises";
import path from "node:path";
import process from "node:process";
import { fileURLToPath } from "node:url";

import sharp from "sharp";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const projectRoot = path.resolve(__dirname, "..");

const PUBLIC_DIR = path.join(projectRoot, "public");
const OUTPUT_FILE = path.join(projectRoot, "src/generated/image-dimensions.ts");

const IMAGE_EXTENSIONS = new Set([".png", ".jpg", ".jpeg", ".webp", ".gif"]);

const isImage = (filename) =>
  IMAGE_EXTENSIONS.has(path.extname(filename).toLowerCase());

async function* walkImages(dir) {
  let entries;
  try {
    entries = await fs.readdir(dir, { withFileTypes: true });
  } catch (err) {
    if (err.code === "ENOENT") {
      console.warn("Folder not found:", dir);
      return;
    }
    throw err;
  }
  for (const entry of entries) {
    const fullPath = path.join(dir, entry.name);
    if (entry.isDirectory()) {
      yield* walkImages(fullPath);
    } else if (entry.isFile() && isImage(entry.name)) {
      yield fullPath;
    }
  }
}

async function getImageDimensions(filePath) {
  const meta = await sharp(filePath).metadata();
  return { w: meta.width, h: meta.height };
}

async function main() {
  console.log("Scanning:", PUBLIC_DIR);

  const dimensions = {};
  let count = 0;

  for await (const filePath of walkImages(PUBLIC_DIR)) {
    try {
      const relativePath = "/" + path.relative(PUBLIC_DIR, filePath);
      const dims = await getImageDimensions(filePath);
      dimensions[relativePath] = dims;
      count++;
    } catch (err) {
      console.error("Error reading:", filePath, err.message);
    }
  }

  const sortedKeys = Object.keys(dimensions).sort();
  const sortedDimensions = {};
  for (const key of sortedKeys) {
    sortedDimensions[key] = dimensions[key];
  }

  const output = `// Auto-generated by scripts/generate-image-manifest.mjs
// Do not edit manually - run: pnpm generate-image-manifest

export const imageDimensions: Record<string, { w: number; h: number }> = ${JSON.stringify(sortedDimensions, null, 2)};
`;

  await fs.mkdir(path.dirname(OUTPUT_FILE), { recursive: true });
  await fs.writeFile(OUTPUT_FILE, output, "utf-8");

  console.log(`Generated ${OUTPUT_FILE}`);
  console.log(`Total images: ${count}`);
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});
